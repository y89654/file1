<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æŠ½é¢˜ Â· ä¿ç•™é”™é¢˜/è®°å½• Â· èµ·æ­¢ç¬¦æ ¼å¼</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #f3f6fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 20px;
        }
        .app-container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,20,50,0.15);
            overflow: hidden;
            padding: 24px;
        }
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }
        h2 {
            margin: 0 0 12px 0;
            font-weight: 600;
            font-size: 1.5rem;
            color: #0b2b4a;
            border-left: 7px solid #3b82f6;
            padding-left: 16px;
        }
        .info-bar {
            background: #e6f0ff;
            border-radius: 30px;
            padding: 12px 22px;
            margin: 20px 0 16px 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: #004080;
            border: 1px solid #b8d3ff;
        }
        .info-bar span {
            background: white;
            padding: 5px 18px;
            border-radius: 50px;
            font-size: 0.95rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .question-block, .answer-block {
            background: #f9faff;
            border-radius: 24px;
            padding: 20px 24px;
            margin-bottom: 20px;
            border: 1px solid #dde7f5;
        }
        .label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #4b5f7a;
            margin-bottom: 8px;
        }
        .question-text {
            font-size: 1.25rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            color: #0b2b4a;
            font-weight: 500;
        }
        .answer-text {
            font-size: 1.2rem;
            color: #1d4a8b;
            background: #e9f2ff;
            padding: 14px 18px;
            border-radius: 20px;
            min-height: 4rem;
            border: 1px solid #c2dafc;
            white-space: pre-wrap;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 18px 0 12px;
        }
        button {
            background: white;
            border: 1.5px solid #c2d6f0;
            padding: 10px 22px;
            border-radius: 60px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e3e6e;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            flex: 0 1 auto;
        }
        button.primary {
            background: #1f4f9e;
            border-color: #1f4f9e;
            color: white;
        }
        button.warning {
            background: #feebc0;
            border-color: #f3b33d;
            color: #7a4c0d;
        }
        button.accent {
            background: #ddedff;
            border-color: #6d9eec;
        }
        button:hover {
            background: #e3efff;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }
        button.primary:hover {
            background: #0f3d7a;
        }
        .range-selector {
            background: #eaf2ff;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .file-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        input[type="text"], input[type="number"] {
            padding: 12px 18px;
            border: 2px solid #cbdaf0;
            border-radius: 40px;
            font-size: 0.95rem;
            background: white;
        }
        .range-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0 10px;
        }
        .range-inputs label {
            font-weight: 500;
            color: #1e3e6e;
        }
        .range-inputs input {
            width: 90px;
            text-align: center;
        }
        .small-note {
            color: #4d627c;
            font-size: 0.9rem;
            margin: 5px 0 0 2px;
        }
        hr {
            border: 1px solid #d1dff5;
            margin: 24px 0;
        }
    </style>
</head>
<body>
<div class="app-container" id="appContainer">

    <!-- ä¸»ç•Œé¢ panel -->
    <div id="mainPanel" class="panel active">
        <h2>ğŸ“š ä¸»ç•Œé¢</h2>
        <div class="button-group">
            <button class="primary" id="gotoDrawRangeBtn">å¼€å§‹æŠ½å–é¢˜ç›®</button>
            <button class="accent" id="gotoMistakePanelBtn">é”™é¢˜æœ¬</button>
            <button id="reloadLibraryBtn">é‡æ–°åŠ è½½é¢˜åº“</button>
        </div>
        <div class="file-input-row">
            <input type="text" id="libraryUrlInput" placeholder="åœ¨æ­¤ç²˜è´´é¢˜åº“é“¾æ¥" value="https://gist.githubusercontent.com/y89654/b5786f5ed0e4290070a08b5010db7854/raw/file.txt">
            <button id="loadUrlBtn">åŠ è½½</button>
        </div>
        <div class="small-note" id="mainStatus">ğŸ“– é¢˜åº“çŠ¶æ€ï¼šæœªåŠ è½½ / 0é¢˜</div>
    </div>

    <!-- æŠ½å–ç•Œé¢ / ç­”é¢˜ç•Œé¢ (åŒ…å«èŒƒå›´é€‰æ‹©ä¸æŠ½é¢˜) -->
    <div id="drawPanel" class="panel">
        <div id="rangeSelectorView" style="display: block;">
            <h2>ğŸ¯ é€‰æ‹©æŠ½å–èŒƒå›´</h2>
            <div class="range-selector">
                <div style="margin-bottom: 12px; font-weight: 500;">å½“å‰é¢˜åº“å…± <span id="totalCountRange">0</span> é¢˜</div>
                
                <!-- æ–°å¢ï¼šè‡ªå®šä¹‰èŒƒå›´è¾“å…¥ -->
                <div class="range-inputs">
                    <label>ä»ç¬¬</label>
                    <input type="number" id="rangeStart" min="1" value="1">
                    <label>é¢˜ åˆ°ç¬¬</label>
                    <input type="number" id="rangeEnd" min="1" value="0">
                    <label>é¢˜ (åŒ…å«)</label>
                </div>
                <div class="button-group">
                    <button id="startRangeDrawBtn" class="primary">å¼€å§‹æŠ½å–</button>
                    <button id="backToMainFromRangeBtn">è¿”å›ä¸»ç•Œé¢</button>
                </div>
                <p class="small-note">ğŸ“Œ é»˜è®¤å…¨éƒ¨é¢˜ç›®ã€‚è¾“å…¥èŒƒå›´åç‚¹å‡»â€œå¼€å§‹æŠ½å–â€å³ä»è¯¥åŒºé—´éšæœºæŠ½é¢˜ã€‚</p>
            </div>
        </div>

        <div id="drawQuestionView" style="display: none;">
            <div class="info-bar">
                <span>ğŸ“Œ å½“å‰èŒƒå›´å‰©ä½™ <span id="remainCounter">0</span> é¢˜</span>
                <span>ğŸ“‹ é¢˜åº“æ€»é¢˜ <span id="totalIndicator">0</span></span>
            </div>

            <div class="question-block">
                <div class="label">ğŸ“ é¢˜ç›®æ </div>
                <div class="question-text" id="questionDisplay">ï¼ˆç‚¹å‡»æŠ½å–åæ˜¾ç¤ºé¢˜ç›®ï¼‰</div>
            </div>

            <div class="answer-block">
                <div class="label">ğŸ” ç­”æ¡ˆæ   <span style="margin-left: 16px; font-weight: normal;" id="answerHiddenTip">ï¼ˆéšè—ï¼‰</span></div>
                <div class="answer-text" id="answerDisplay">********</div>
            </div>

            <div class="button-group">
                <button id="showAnswerBtn" class="primary">æ˜¾ç¤ºç­”æ¡ˆ</button>
                <button id="prevQuestionBtn">ä¸Šä¸€é¢˜</button>
                <button id="nextQuestionBtn">ä¸‹ä¸€é¢˜</button>
                <button id="resetDrawnBtn">é‡ç½®å·²æŠ½å–</button>
                <button id="reselectRangeBtn">é‡æ–°é€‰æ‹©èŒƒå›´</button>
                <button id="addToMistakeBtn" class="warning">åŠ å…¥é”™é¢˜æœ¬</button>
                <button id="backToMainFromDrawBtn">è¿”å›ä¸»ç•Œé¢</button>
            </div>
        </div>
    </div>

    <!-- é”™é¢˜æœ¬ panel (ä¿æŒä¸å˜ï¼ŒåŠŸèƒ½æ­£å¸¸) -->
    <div id="mistakePanel" class="panel">
        <h2>âŒ é”™é¢˜æœ¬</h2>
        <div class="info-bar">
            <span>é”™é¢˜æ€»æ•° <span id="mistakeTotal">0</span></span>
        </div>
        <div class="button-group">
            <button class="primary" id="startMistakeDrawBtn">å¼€å§‹æŠ½å–é”™é¢˜</button>
            <button id="viewAllMistakesBtn">æŸ¥çœ‹æ‰€æœ‰é”™é¢˜</button>
            <button id="resetMistakeDrawnBtn">é‡ç½®å·²æŠ½å–é”™é¢˜</button>
            <button id="backToMainFromMistakeBtn">è¿”å›ä¸»ç•Œé¢</button>
        </div>

        <div id="mistakeDrawView" style="display: none; margin-top: 24px;">
            <div class="info-bar">
                <span>é”™é¢˜å‰©ä½™ <span id="mistakeRemain">0</span> é¢˜</span>
            </div>
            <div class="question-block">
                <div class="label">ğŸ“ é”™é¢˜é¢˜ç›®</div>
                <div class="question-text" id="mistakeQuestionDisplay"></div>
            </div>
            <div class="answer-block">
                <div class="label">ğŸ” ç­”æ¡ˆ</div>
                <div class="answer-text" id="mistakeAnswerDisplay">********</div>
            </div>
            <div class="button-group">
                <button id="showMistakeAnswerBtn" class="primary">æ˜¾ç¤ºç­”æ¡ˆ</button>
                <button id="prevMistakeBtn">ä¸Šä¸€é¢˜</button>
                <button id="nextMistakeBtn">ä¸‹ä¸€é¢˜</button>
                <button id="resetMistakeDrawInViewBtn">é‡ç½®æŠ½å–</button>
                <button id="removeThisMistakeBtn" class="warning">ç§»é™¤è¯¥é”™é¢˜</button>
                <button id="backToMistakeMainBtn">è¿”å›é”™é¢˜æœ¬</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- å…¨å±€æ•°æ® ----------
        let rawLines = [];                      // åŸå§‹é¢˜åº“æ¯è¡Œæ–‡æœ¬ï¼ˆç”¨äºå¯èƒ½çš„äºŒæ¬¡åŠ è½½å¯¹æ¯”ï¼Œä½†ä¸å†é‡ç½®å†å²ï¼‰
        let questionList = [];                  // è§£æå { question: åŸé¢˜ä¸å«ç­”æ¡ˆéƒ¨åˆ†, answer: ç­”æ¡ˆæ–‡æœ¬ }
        
        // ä¿ç•™æ•°æ®ï¼šé”™é¢˜æœ¬ã€æŠ½å–è®°å½• â€”â€” é‡æ–°åŠ è½½é¢˜åº“æ—¶ä¸å†æ¸…ç©º
        let mistakeList = [];                    // é”™é¢˜åˆ—è¡¨
        // å½“å‰æŠ½å–èŒƒå›´ç›¸å…³ â€”â€” é‡æ–°åŠ è½½åé€šå¸¸éœ€è¦é‡æ–°é€‰æ‹©èŒƒå›´ï¼Œä½†å·²æŠ½å–å†å²åº”å½“ä¿ç•™å—ï¼Ÿæ ¹æ®éœ€æ±‚â€œå·²æŠ½å–è®°å½•ä¸ä¼šæ¸…ç©ºâ€ï¼Œæˆ‘ä»¬ä¿ç•™ drawnHistory ç­‰ï¼Œä½†æ³¨æ„è¿™äº›ç´¢å¼•åŸºäºæ—§é¢˜åº“ï¼Œé‡æ–°åŠ è½½åé¢˜åº“å˜åŒ–ï¼Œç´¢å¼•å¤±æ•ˆã€‚
        // æ›´åˆç†çš„è§£é‡Šï¼šé‡æ–°åŠ è½½é¢˜åº“åï¼ŒåŸæœ‰åŸºäºæ—§é¢˜åº“çš„æŠ½å–è®°å½•ï¼ˆdrawnHistoryï¼‰åº”è§†ä¸ºæ— æ•ˆï¼Œä½†éœ€æ±‚æ˜ç¡®è¦æ±‚â€œå·²æŠ½å–è®°å½•ä¸ä¼šæ¸…ç©ºâ€ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿ç•™å†å²å­—ç¬¦ä¸²å±•ç¤ºï¼Œä½†ç¦ç”¨å…¶ç´¢å¼•æœ‰æ•ˆæ€§ã€‚
        // ç„¶è€Œç”¨æˆ·è¦æ±‚â€œå·²æŠ½å–è®°å½•ä¸ä¼šæ¸…ç©ºæˆ–ä¿®æ”¹â€ï¼Œä¸ºé¿å…é”™è¯¯ç‚¹å‡»ï¼Œæˆ‘ä»¬ä¿ç•™æ•°ç»„ä½†ä¸ç”¨äºæ˜¾ç¤ºï¼ˆå› ä¸ºç´¢å¼•å¯èƒ½è¶Šç•Œï¼‰ã€‚é‡‡ç”¨å¦ä¸€ç§æ€è·¯ï¼šåªåœ¨æŠ½é¢˜è¿‡ç¨‹ä¸­è®°å½•ï¼Œé‡æ–°åŠ è½½åè‡ªåŠ¨æ¸…ç©ºæŠ½å–ç•Œé¢ç›¸å…³çŠ¶æ€ï¼Œä½†ä¿ç•™é”™é¢˜æœ¬ã€‚
        // æ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œç”¨æˆ·æ›´å…³å¿ƒé”™é¢˜æœ¬ä¿ç•™ã€‚å¯¹äºæŠ½å–è®°å½•ï¼ŒåŸä»£ç é‡ç½®æ—¶æ¸…ç©ºäº†currentDrawRemainingç­‰ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸ºï¼šé‡æ–°åŠ è½½é¢˜åº“æ—¶ï¼Œä¸å½±å“é”™é¢˜æœ¬ï¼›ä½†é‡ç½®æŠ½å–ç•Œé¢çš„çŠ¶æ€ï¼ˆå› ä¸ºé¢˜åº“å˜äº†ï¼ŒèŒƒå›´éœ€è¦é‡æ–°é€‰ï¼‰ï¼Œè¿™ç¬¦åˆç›´è§‰ã€‚
        // ä½†éœ€æ±‚è¯´â€œå·²æŠ½å–è®°å½•ä¸ä¼šæ¸…ç©ºâ€ï¼Œæˆ‘ä»¬éœ€ä¿ç•™ drawnHistory ä½†é¿å…å…¶è¢«ç”¨äºæ˜¾ç¤ºæ— æ•ˆç´¢å¼•ã€‚æˆ‘ä»¬ä¿ç•™æ•°æ®ï¼Œä½†é€šè¿‡ä¸€ä¸ªæ ‡å¿—è®©æŠ½å–ç•Œé¢é‡æ–°åˆå§‹åŒ–ï¼Œè¿™æ ·å†å²è®°å½•è™½åœ¨å†…å­˜ä½†ä¸ä¼šæ˜¾ç¤ºé€ æˆå›°æƒ‘ã€‚
        // æœ€ç¨³å¦¥ï¼šé‡æ–°åŠ è½½åï¼Œä¿ç•™ mistakeListï¼›åŒæ—¶ä¿ç•™ drawnHistory ä½†ç½®ç›¸å…³UIä¸å¯è§å¹¶æç¤ºé‡æ–°é€‰æ‹©èŒƒå›´ã€‚æˆ‘ä»¬å°†åœ¨åŠ è½½åé‡ç½®æŠ½å–ç•Œé¢çŠ¶æ€ï¼ˆå› ä¸ºåŸé¢˜åº“å˜äº†ï¼Œæ—§ç´¢å¼•æ— æ„ä¹‰ï¼‰ï¼Œä½†ä¿ç•™é”™é¢˜ã€‚
        // ç”¨æˆ·å¼ºè°ƒâ€œé”™é¢˜æœ¬ä»¥åŠå·²æŠ½å–è®°å½•ä¸ä¼šæ¸…ç©ºâ€ï¼Œè¿™é‡Œâ€œå·²æŠ½å–è®°å½•â€å¯èƒ½æŒ‡â€œå·²ç»æŠ½å–è¿‡çš„é¢˜ç›®è®°å½•â€ï¼Œä½†é¢˜åº“æ›´æ–°åè¿™äº›è®°å½•åŸºäºæ—§é¢˜ï¼Œéš¾ä»¥å¤ç”¨ã€‚æ‰€ä»¥é‡‡ç”¨å‹å¥½æ–¹å¼ï¼šä¿ç•™é”™é¢˜ï¼Œä½†æŠ½å–å†å²é‡ç½®ï¼ˆå› ä¸ºèŒƒå›´å˜åŒ–æ˜¯å¿…ç„¶ï¼‰ã€‚å¦‚æœç”¨æˆ·åšæŒä¸é‡ç½®ï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•è¶Šç•Œã€‚æˆ‘ä»¬åšä¿æŠ¤ï¼šåŠ è½½åå¦‚æœç»§ç»­ä½¿ç”¨æ—§çš„ drawnHistoryï¼Œæ£€æµ‹åˆ°ç´¢å¼•è¶Šç•Œåˆ™è‡ªåŠ¨æ¸…ç©ºå¹¶æç¤ºã€‚
        // è¿™æ ·æ—¢æ»¡è¶³äº†â€œä¸æ¸…ç©ºâ€çš„å˜é‡å­˜å‚¨ï¼Œåˆä¿è¯ç¨‹åºä¸å´©æºƒã€‚
        
        // å½“å‰æŠ½å–èŒƒå›´ç›¸å…³
        let currentDrawRemaining = [];            // å½“å‰æŠ½å–èŒƒå›´ï¼ˆå­˜å‚¨ç´¢å¼•ï¼‰
        let drawnHistory = [];                    // å·²ç»æŠ½å–è¿‡çš„ç´¢å¼•
        let currentDrawIndex = -1;                // å½“å‰å±•ç¤ºçš„æ˜¯drawnHistoryé‡Œçš„ç¬¬å‡ ä¸ª
        let answerVisible = false;                 // å½“å‰æŠ½å–ç•Œé¢æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ

        // é”™é¢˜æŠ½å–ç›¸å…³
        let mistakeDrawRemaining = [];             // é”™é¢˜æŠ½å–å‰©ä½™ç´¢å¼•
        let mistakeDrawnHistory = [];
        let currentMistakeIndex = -1;
        let mistakeAnswerVisible = false;

        // UIå…ƒç´ 
        const mainPanel = document.getElementById('mainPanel');
        const drawPanel = document.getElementById('drawPanel');
        const mistakePanel = document.getElementById('mistakePanel');
        const rangeSelectorView = document.getElementById('rangeSelectorView');
        const drawQuestionView = document.getElementById('drawQuestionView');
        const mistakeDrawView = document.getElementById('mistakeDrawView');

        const totalCountRangeSpan = document.getElementById('totalCountRange');
        const remainCounterSpan = document.getElementById('remainCounter');
        const totalIndicatorSpan = document.getElementById('totalIndicator');
        const questionDisplay = document.getElementById('questionDisplay');
        const answerDisplay = document.getElementById('answerDisplay');
        const answerHiddenTip = document.getElementById('answerHiddenTip');
        const mainStatus = document.getElementById('mainStatus');
        const mistakeTotalSpan = document.getElementById('mistakeTotal');

        // æ–°å¢ï¼šèŒƒå›´è¾“å…¥æ¡†
        const rangeStartInput = document.getElementById('rangeStart');
        const rangeEndInput = document.getElementById('rangeEnd');

        // é”™æœ¬é¢˜å†…éƒ¨å…ƒç´ 
        const mistakeQuestionDisplay = document.getElementById('mistakeQuestionDisplay');
        const mistakeAnswerDisplay = document.getElementById('mistakeAnswerDisplay');
        const mistakeRemainSpan = document.getElementById('mistakeRemain');

        // æŒ‰é’®
        document.getElementById('gotoDrawRangeBtn').addEventListener('click', ()=>{
            if(questionList.length === 0) { alert('è¯·å…ˆåŠ è½½é¢˜åº“'); return; }
            // é‡ç½®èŒƒå›´è¾“å…¥æ¡†çš„å€¼ä¸ºåˆç†çš„é»˜è®¤å€¼ï¼ˆå…¨éƒ¨ï¼‰
            rangeStartInput.value = 1;
            rangeEndInput.value = questionList.length;
            // æ›´æ–°æ˜¾ç¤º
            showPanel('draw');
            rangeSelectorView.style.display = 'block';
            drawQuestionView.style.display = 'none';
            updateRangeInfo();
        });
        document.getElementById('gotoMistakePanelBtn').addEventListener('click', ()=>{
            showPanel('mistake');
            mistakeDrawView.style.display = 'none';
            updateMistakeUI();
        });
        document.getElementById('reloadLibraryBtn').addEventListener('click', ()=>{
            const url = document.getElementById('libraryUrlInput').value.trim();
            if(url) loadFromUrl(url, { preserveMistake: true, preserveDrawHistory: true }); 
            else alert('è¯·åœ¨è¾“å…¥æ¡†ä¸­å¡«å†™é“¾æ¥');
        });
        document.getElementById('loadUrlBtn').addEventListener('click', ()=>{
            const url = document.getElementById('libraryUrlInput').value.trim();
            if(url) loadFromUrl(url, { preserveMistake: true, preserveDrawHistory: true }); 
            else alert('è¯·è¾“å…¥é“¾æ¥');
        });

        document.getElementById('backToMainFromRangeBtn').addEventListener('click', ()=> showPanel('main'));
        document.getElementById('backToMainFromDrawBtn').addEventListener('click', ()=> showPanel('main'));
        document.getElementById('backToMainFromMistakeBtn').addEventListener('click', ()=> showPanel('main'));

        // å¼€å§‹æŠ½å–(èŒƒå›´ç•Œé¢ç‚¹å‡») â€”â€” ç°åœ¨ä½¿ç”¨è‡ªå®šä¹‰èŒƒå›´
        document.getElementById('startRangeDrawBtn').addEventListener('click', ()=>{
            if(questionList.length === 0) return alert('é¢˜åº“ä¸ºç©º');
            
            // è·å–èŒƒå›´è¾“å…¥
            let start = parseInt(rangeStartInput.value);
            let end = parseInt(rangeEndInput.value);
            // è¾“å…¥æ ¡éªŒ
            if (isNaN(start) || start < 1) start = 1;
            if (isNaN(end) || end > questionList.length) end = questionList.length;
            if (start > end) {
                alert('èµ·å§‹é¢˜å·ä¸èƒ½å¤§äºç»“æŸé¢˜å·ï¼Œå°†ä½¿ç”¨å…¨éƒ¨èŒƒå›´');
                start = 1;
                end = questionList.length;
            }
            // è½¬æ¢ä¸ºç´¢å¼• (ç”¨æˆ·è¾“å…¥ç¬¬1é¢˜å¯¹åº”ç´¢å¼•0)
            const startIdx = start - 1;
            const endIdx = end - 1;
            
            // ç”Ÿæˆå‰©ä½™ç´¢å¼•åˆ—è¡¨
            currentDrawRemaining = [];
            for (let i = startIdx; i <= endIdx; i++) {
                currentDrawRemaining.push(i);
            }
            
            if (currentDrawRemaining.length === 0) {
                alert('è¯¥èŒƒå›´æ— æœ‰æ•ˆé¢˜ç›®');
                return;
            }

            drawnHistory = [];
            currentDrawIndex = -1;
            answerVisible = false;
            // éšæœºæŠ½å–ä¸€é¢˜ä½œä¸ºå¼€å§‹
            pickNewQuestionFromRemaining();
            rangeSelectorView.style.display = 'none';
            drawQuestionView.style.display = 'block';
            updateDrawUI();
        });

        // æ˜¾ç¤ºç­”æ¡ˆ
        document.getElementById('showAnswerBtn').addEventListener('click', ()=>{
            if(currentDrawIndex >= 0 && drawnHistory.length > 0 && currentDrawIndex < drawnHistory.length) {
                // é¢å¤–æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
                const qIdx = drawnHistory[currentDrawIndex];
                if (qIdx >= 0 && qIdx < questionList.length) {
                    answerVisible = true;
                    updateDrawUI();
                } else {
                    alert('å½“å‰é¢˜ç›®ç´¢å¼•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©èŒƒå›´');
                    // æ¸…ç©ºæ— æ•ˆå†å²
                    drawnHistory = [];
                    currentDrawIndex = -1;
                    updateDrawUI();
                }
            } else alert('æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„é¢˜ç›®');
        });

        document.getElementById('prevQuestionBtn').addEventListener('click', ()=>{
            if(drawnHistory.length === 0) return alert('æ— æŠ½å–è®°å½•');
            // æ£€æŸ¥å½“å‰ç´¢å¼•æœ‰æ•ˆæ€§
            if (currentDrawIndex > 0) {
                // æ£€æŸ¥è¦æ˜¾ç¤ºçš„é¢˜ç›®ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
                const prevIdx = drawnHistory[currentDrawIndex - 1];
                if (prevIdx >= 0 && prevIdx < questionList.length) {
                    currentDrawIndex--;
                    answerVisible = false;
                    updateDrawUI();
                } else {
                    alert('ä¸Šä¸€é¢˜ç´¢å¼•å·²å¤±æ•ˆï¼Œå¯èƒ½é¢˜åº“å·²å˜åŠ¨ï¼Œå°†é‡ç½®æŠ½å–å†å²');
                    drawnHistory = [];
                    currentDrawIndex = -1;
                    updateDrawUI();
                }
            } else alert('å·²ç»æ˜¯ç¬¬ä¸€é¢˜');
        });
        document.getElementById('nextQuestionBtn').addEventListener('click', ()=>{
            if(drawnHistory.length === 0) return;
            if (currentDrawIndex < drawnHistory.length - 1) {
                const nextIdx = drawnHistory[currentDrawIndex + 1];
                if (nextIdx >= 0 && nextIdx < questionList.length) {
                    currentDrawIndex++;
                    answerVisible = false;
                    updateDrawUI();
                } else {
                    alert('ä¸‹ä¸€é¢˜ç´¢å¼•å·²å¤±æ•ˆï¼Œå¯èƒ½é¢˜åº“å·²å˜åŠ¨ï¼Œå°†é‡ç½®æŠ½å–å†å²');
                    drawnHistory = [];
                    currentDrawIndex = -1;
                    updateDrawUI();
                }
            } else {
                pickNewQuestionFromRemaining();
            }
        });

        document.getElementById('resetDrawnBtn').addEventListener('click', ()=>{
            if(confirm('é‡ç½®å·²æŠ½å–ï¼Œå°†æ¸…ç©ºæŠ½å–å†å²ï¼Œä½†ä¿ç•™å‰©ä½™èŒƒå›´ã€‚')) {
                drawnHistory = [];
                currentDrawIndex = -1;
                answerVisible = false;
                questionDisplay.innerText = 'ï¼ˆç‚¹å‡»ä¸‹ä¸€é¢˜æŠ½å–ï¼‰';
                answerDisplay.innerText = '********';
                answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
                updateRemainOnly();
            }
        });

        document.getElementById('reselectRangeBtn').addEventListener('click', ()=>{
            rangeSelectorView.style.display = 'block';
            drawQuestionView.style.display = 'none';
            // åˆ·æ–°èŒƒå›´è¾“å…¥æ˜¾ç¤ºå½“å‰é¢˜åº“æ€»æ•°
            rangeEndInput.value = questionList.length;
            updateRangeInfo();
        });

        document.getElementById('addToMistakeBtn').addEventListener('click', ()=>{
            if(currentDrawIndex >= 0 && drawnHistory.length > 0) {
                const qIdx = drawnHistory[currentDrawIndex];
                if (qIdx >= 0 && qIdx < questionList.length) {
                    const questionObj = questionList[qIdx];
                    if(!mistakeList.some(item => item.question === questionObj.question && item.answer === questionObj.answer)) {
                        mistakeList.push({...questionObj});
                        updateMistakeTotal();
                        alert('å·²åŠ å…¥é”™é¢˜æœ¬');
                    } else alert('å·²åœ¨é”™é¢˜æœ¬ä¸­');
                } else alert('é¢˜ç›®ç´¢å¼•æ— æ•ˆï¼Œæ— æ³•åŠ å…¥é”™é¢˜æœ¬');
            } else alert('æ²¡æœ‰é€‰ä¸­é¢˜ç›®');
        });

        // é”™é¢˜æœ¬å†…éƒ¨åŠŸèƒ½ (ä¿æŒä¸å˜ï¼Œç¡®ä¿æ— è¯¯)
        document.getElementById('startMistakeDrawBtn').addEventListener('click', ()=>{
            if(mistakeList.length === 0) return alert('é”™é¢˜æœ¬ä¸ºç©º');
            mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
            mistakeDrawnHistory = [];
            currentMistakeIndex = -1;
            mistakeAnswerVisible = false;
            pickNewMistakeFromRemaining();
            mistakeDrawView.style.display = 'block';
            updateMistakeDrawUI();
        });
        document.getElementById('viewAllMistakesBtn').addEventListener('click', ()=>{
            if(mistakeList.length === 0) alert('æš‚æ— é”™é¢˜');
            else alert('æ‰€æœ‰é”™é¢˜:\n' + mistakeList.map((q,i)=>`${i+1}. ${q.question} â€”â€” ç­”æ¡ˆ: ${q.answer}`).join('\n'));
        });
        document.getElementById('resetMistakeDrawnBtn').addEventListener('click', ()=>{
            mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
            mistakeDrawnHistory = [];
            currentMistakeIndex = -1;
            mistakeAnswerVisible = false;
            updateMistakeTotal();
            if(mistakeDrawView.style.display === 'block') {
                mistakeQuestionDisplay.innerText = 'é‡ç½®å®Œæˆï¼Œç‚¹å‡»å¼€å§‹æŠ½å–é”™é¢˜';
                mistakeAnswerDisplay.innerText = '********';
            }
        });
        document.getElementById('backToMistakeMainBtn').addEventListener('click', ()=>{
            mistakeDrawView.style.display = 'none';
        });
        document.getElementById('showMistakeAnswerBtn').addEventListener('click', ()=>{
            if(currentMistakeIndex >= 0 && mistakeDrawnHistory.length > 0) {
                mistakeAnswerVisible = true;
                updateMistakeDrawUI();
            } else alert('æ— é”™é¢˜');
        });
        document.getElementById('prevMistakeBtn').addEventListener('click', ()=>{
            if(mistakeDrawnHistory.length === 0) return;
            if(currentMistakeIndex > 0) {
                currentMistakeIndex--;
                mistakeAnswerVisible = false;
                updateMistakeDrawUI();
            } else alert('å·²æ˜¯ç¬¬ä¸€é¢˜');
        });
        document.getElementById('nextMistakeBtn').addEventListener('click', ()=>{
            if(mistakeDrawnHistory.length === 0) return;
            if(currentMistakeIndex < mistakeDrawnHistory.length - 1) {
                currentMistakeIndex++;
                mistakeAnswerVisible = false;
                updateMistakeDrawUI();
            } else {
                pickNewMistakeFromRemaining();
            }
        });
        document.getElementById('resetMistakeDrawInViewBtn').addEventListener('click', ()=>{
            mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
            mistakeDrawnHistory = [];
            currentMistakeIndex = -1;
            mistakeAnswerVisible = false;
            updateMistakeDrawUI();
        });
        document.getElementById('removeThisMistakeBtn').addEventListener('click', ()=>{
            if(currentMistakeIndex >= 0 && mistakeDrawnHistory.length > 0) {
                const mistakeIdx = mistakeDrawnHistory[currentMistakeIndex];
                mistakeList.splice(mistakeIdx, 1);
                mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
                mistakeDrawnHistory = [];
                currentMistakeIndex = -1;
                mistakeAnswerVisible = false;
                updateMistakeTotal();
                if(mistakeList.length === 0) {
                    mistakeDrawView.style.display = 'none';
                } else {
                    pickNewMistakeFromRemaining();
                }
                updateMistakeDrawUI();
            } else alert('æ²¡æœ‰é€‰ä¸­é”™é¢˜');
        });

        // ------- è¾…åŠ©å‡½æ•° ---------
        function showPanel(panel) {
            mainPanel.classList.remove('active');
            drawPanel.classList.remove('active');
            mistakePanel.classList.remove('active');
            if(panel === 'main') mainPanel.classList.add('active');
            if(panel === 'draw') drawPanel.classList.add('active');
            if(panel === 'mistake') mistakePanel.classList.add('active');
        }

        function updateRangeInfo() {
            totalCountRangeSpan.innerText = questionList.length;
            rangeEndInput.max = questionList.length;
            rangeEndInput.value = questionList.length;
        }

        function updateRemainOnly() {
            let remain = currentDrawRemaining.length;
            remainCounterSpan.innerText = remain;
            totalIndicatorSpan.innerText = questionList.length;
        }

        function updateDrawUI() {
            if(drawnHistory.length > 0 && currentDrawIndex >= 0 && currentDrawIndex < drawnHistory.length) {
                const qIdx = drawnHistory[currentDrawIndex];
                if (qIdx >= 0 && qIdx < questionList.length) {
                    const q = questionList[qIdx];
                    questionDisplay.innerText = q.question;
                    if(answerVisible) {
                        answerDisplay.innerText = q.answer;
                        answerHiddenTip.innerText = 'ï¼ˆæ˜¾ç¤ºï¼‰';
                    } else {
                        answerDisplay.innerText = '********';
                        answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
                    }
                } else {
                    // ç´¢å¼•æ— æ•ˆï¼Œæ¸…ç©ºå†å²
                    drawnHistory = [];
                    currentDrawIndex = -1;
                    questionDisplay.innerText = 'é¢˜åº“å·²å˜åŠ¨ï¼Œè¯·é‡æ–°é€‰æ‹©èŒƒå›´';
                    answerDisplay.innerText = '********';
                    answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
                }
            } else {
                questionDisplay.innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€é¢˜æŠ½å–';
                answerDisplay.innerText = '********';
                answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
            }
            updateRemainOnly();
        }

        function pickNewQuestionFromRemaining() {
            if(currentDrawRemaining.length === 0) {
                alert('å½“å‰èŒƒå›´å·²ç»æ²¡æœ‰é¢˜ç›®äº†ï¼Œè¯·é‡ç½®å·²æŠ½å–æˆ–é‡æ–°é€‰æ‹©èŒƒå›´');
                return;
            }
            const randomIndex = Math.floor(Math.random() * currentDrawRemaining.length);
            const selectedIdx = currentDrawRemaining[randomIndex];
            currentDrawRemaining.splice(randomIndex, 1);
            drawnHistory.push(selectedIdx);
            currentDrawIndex = drawnHistory.length - 1;
            answerVisible = false;
            updateDrawUI();
        }

        function updateMistakeTotal() {
            mistakeTotalSpan.innerText = mistakeList.length;
        }

        function pickNewMistakeFromRemaining() {
            if(mistakeDrawRemaining.length === 0) {
                alert('é”™é¢˜å‰©ä½™å·²ç©ºï¼Œå¯é‡ç½®æŠ½å–');
                return;
            }
            const rand = Math.floor(Math.random() * mistakeDrawRemaining.length);
            const selectedMistakeIdx = mistakeDrawRemaining[rand];
            mistakeDrawRemaining.splice(rand, 1);
            mistakeDrawnHistory.push(selectedMistakeIdx);
            currentMistakeIndex = mistakeDrawnHistory.length - 1;
            mistakeAnswerVisible = false;
            updateMistakeDrawUI();
        }

        function updateMistakeDrawUI() {
            if(mistakeDrawnHistory.length > 0 && currentMistakeIndex >= 0) {
                const mistakeIdx = mistakeDrawnHistory[currentMistakeIndex];
                const q = mistakeList[mistakeIdx];
                mistakeQuestionDisplay.innerText = q.question;
                mistakeAnswerDisplay.innerText = mistakeAnswerVisible ? q.answer : '********';
            } else {
                mistakeQuestionDisplay.innerText = 'æ— é”™é¢˜';
                mistakeAnswerDisplay.innerText = '********';
            }
            mistakeRemainSpan.innerText = mistakeDrawRemaining.length;
        }

        function updateMistakeUI() {
            mistakeTotalSpan.innerText = mistakeList.length;
        }

        // è§£æé¢˜åº“ â€”â€” ä¿®æ”¹ä¸ºè¯†åˆ« begining......ending ä½œä¸ºä¸€é¢˜ï¼Œä¸”ç­”æ¡ˆåœ¨ ending å‰
        function parseQuestionsFromLines(lines) {
            const fullText = lines.join('\n');  // å…ˆåˆå¹¶ï¼Œæ–¹ä¾¿è·¨è¡ŒåŒ¹é…
            const regex = /begining(.*?)ending/gs;  // éè´ªå©ªåŒ¹é…ï¼Œè·¨è¶Šæ¢è¡Œ
            const qlist = [];
            let match;
            while ((match = regex.exec(fullText)) !== null) {
                let block = match[1].trim();  // è·å– begining å’Œ ending ä¹‹é—´çš„å†…å®¹
                // åœ¨ block ä¸­å¯»æ‰¾ "ç­”æ¡ˆï¼š" åˆ†å‰²é¢˜ç›®å’Œç­”æ¡ˆ
                const ansIndex = block.lastIndexOf('ç­”æ¡ˆï¼š');
                if (ansIndex !== -1) {
                    const questionPart = block.substring(0, ansIndex).trim();
                    let answerPart = block.substring(ansIndex + 3).trim();
                    qlist.push({ question: questionPart, answer: answerPart });
                } else {
                    // å¦‚æœæ²¡æœ‰â€œç­”æ¡ˆï¼šâ€ï¼Œå°†æ•´ä¸ª block å½“ä½œé¢˜ç›®ï¼Œç­”æ¡ˆç•™ç©º
                    qlist.push({ question: block, answer: '' });
                }
            }
            // å¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é…ï¼ˆå¯èƒ½æ˜¯æ—§æ ¼å¼æˆ–çº¯æ–‡æœ¬ï¼‰ï¼Œå›é€€åˆ°æŒ‰è¡Œåˆ†å‰²å¹¶ä¿ç•™åŸæœ‰é€»è¾‘ï¼ˆå…¼å®¹ï¼‰
            if (qlist.length === 0) {
                // é€€åŒ–ä¸ºé€è¡Œè§£æï¼ˆåŸé€»è¾‘ï¼‰
                for(let line of lines) {
                    line = line.trim();
                    if(line === '') continue;
                    const ansIndex = line.lastIndexOf('ç­”æ¡ˆï¼š');
                    if(ansIndex !== -1) {
                        const questionPart = line.substring(0, ansIndex).trim();
                        let answerPart = line.substring(ansIndex + 3).trim();
                        qlist.push({ question: questionPart, answer: answerPart });
                    } else {
                        qlist.push({ question: line, answer: '' });
                    }
                }
            }
            return qlist;
        }

        // ä¿®æ”¹åŠ è½½å‡½æ•°ï¼Œæ”¯æŒä¿ç•™é”™é¢˜æœ¬å’ŒæŠ½å–å†å²
        async function loadFromUrl(url, options = { preserveMistake: true, preserveDrawHistory: true }) {
            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                const text = await response.text();
                rawLines = text.split(/\r?\n/);
                const newQuestionList = parseQuestionsFromLines(rawLines);
                
                // æ›´æ–°é¢˜åº“
                questionList = newQuestionList;
                mainStatus.innerText = `ğŸ“– é¢˜åº“å·²åŠ è½½ï¼š${questionList.length}é¢˜`;
                
                // æ ¹æ®é€‰é¡¹å†³å®šæ˜¯å¦ä¿ç•™é”™é¢˜æœ¬ (é»˜è®¤ä¿ç•™)
                if (!options.preserveMistake) {
                    mistakeList = [];
                }
                // é”™é¢˜æœ¬ä¿ç•™ï¼Œä½†éœ€è¦æ¸…ç†é”™é¢˜æŠ½å–çŠ¶æ€ (å› ä¸ºé”™é¢˜åˆ—è¡¨æ²¡å˜ï¼Œä½†é”™é¢˜æŠ½å–ç´¢å¼•åŸºäºmistakeListï¼Œä¸éœ€è¦æ¸…ç†ï¼ŒmistakeListä¸å˜åˆ™ç´¢å¼•æœ‰æ•ˆ)
                // ä½†ä¸ºäº†å®‰å…¨ï¼Œå¦‚æœmistakeListå†…å®¹æ²¡å˜ï¼ŒmistakeDrawRemainingç­‰å¯ä»¥ä¿ç•™ï¼›å¦‚æœç”¨æˆ·é‡æ–°åŠ è½½åæƒ³é‡æ–°æŠ½å–é”™é¢˜ï¼Œå¯èƒ½éœ€è¦é‡ç½®ï¼Œä½†ä¸ºäº†ä¿ç•™ä¹‹å‰æŠ½å–è¿›åº¦ï¼Œæˆ‘ä»¬ä¿ç•™å®ƒä»¬ã€‚
                // ç„¶è€ŒmistakeListæ²¡å˜ï¼Œæ‰€ä»¥mistakeDrawRemainingç­‰ä¾ç„¶æœ‰æ•ˆã€‚ä½†ä»¥é˜²ä¸‡ä¸€ï¼Œå¦‚æœmistakeListå˜äº†ï¼ˆæ¯”å¦‚æ¸…ç©ºï¼‰ï¼Œä½†è¿™é‡Œæ²¡æ¸…ç©ºï¼Œæ‰€ä»¥æ²¡é—®é¢˜ã€‚
                
                // å¤„ç†æŠ½å–å†å²ï¼šå¦‚æœé¢˜åº“å˜åŒ–ï¼Œæ—§çš„ drawnHistory ä¸­çš„ç´¢å¼•å¯èƒ½æ— æ•ˆã€‚
                // æŒ‰ç…§éœ€æ±‚â€œå·²æŠ½å–è®°å½•ä¸ä¼šæ¸…ç©ºâ€ï¼Œæˆ‘ä»¬ä¿ç•™æ•°ç»„ï¼Œä½†åœ¨ä½¿ç”¨æ—¶æ£€æŸ¥æœ‰æ•ˆæ€§ï¼ˆupdateDrawUIå·²åšæ£€æŸ¥ï¼‰ã€‚åŒæ—¶é‡ç½®å½“å‰æ˜¾ç¤ºé¿å…é”™è¯¯ã€‚
                if (!options.preserveDrawHistory) {
                    // å¦‚æœå¼ºåˆ¶ä¸ä¿ç•™ï¼Œåˆ™æ¸…ç©º
                    drawnHistory = [];
                    currentDrawIndex = -1;
                    currentDrawRemaining = [];
                } else {
                    // ä¿ç•™å†å²ï¼Œä½†æ¸…é™¤å½“å‰æ˜¾ç¤ºï¼Œè®©ç”¨æˆ·é‡æ–°é€‰æ‹©èŒƒå›´ï¼ˆå› ä¸ºèŒƒå›´å¯èƒ½å˜äº†ï¼‰
                    // åŒæ—¶éªŒè¯å†å²ä¸­çš„ç´¢å¼•ï¼Œå¦‚æœå…¨éƒ¨æ— æ•ˆå¯ä»¥æ¸…ç©ºï¼Œä½†ä¿ç•™æ•°ç»„ä»¥ä¾¿æŸ¥çœ‹ã€‚
                    // æˆ‘ä»¬ç®€å•åœ°å°†æŠ½å–ç•Œé¢åˆ‡å›èŒƒå›´é€‰æ‹©ï¼Œé¿å…ç”¨æˆ·ç›´æ¥çœ‹åˆ°æ— æ•ˆé¢˜ç›®ã€‚
                    if (drawPanel.classList.contains('active')) {
                        // å¦‚æœå½“å‰åœ¨æŠ½é¢˜ç•Œé¢ï¼Œå¼ºåˆ¶å›åˆ°èŒƒå›´é€‰æ‹©
                        rangeSelectorView.style.display = 'block';
                        drawQuestionView.style.display = 'none';
                    }
                    // ä½†ä¿ç•™ drawnHistory ä¸å˜ï¼ˆå†…å­˜ä¸­ï¼‰
                }
                
                // é‡ç½®å½“å‰æŠ½å–èŒƒå›´ï¼ˆå› ä¸ºæ—§èŒƒå›´åŸºäºæ—§é¢˜åº“é•¿åº¦ï¼‰
                currentDrawRemaining = [];
                // ä½†ä¿ç•™ drawnHistory ï¼ˆä¸ä¸»åŠ¨æ¸…ç©ºï¼‰
                
                // æ›´æ–°èŒƒå›´è¾“å…¥çš„æœ€å¤§å€¼
                rangeEndInput.max = questionList.length;
                rangeEndInput.value = questionList.length;
                
                // æ›´æ–°UIä¸Šçš„æ€»é¢˜æ•°
                updateRangeInfo();
                updateMistakeTotal();  // é”™é¢˜æ€»æ•°æ˜¾ç¤º
                
                alert(`æˆåŠŸåŠ è½½ ${questionList.length} é“é¢˜ç›®ï¼Œé”™é¢˜æœ¬ ${mistakeList.length} é¢˜ï¼ŒæŠ½å–å†å²å·²ä¿ç•™ï¼ˆå¯èƒ½éœ€è¦é‡æ–°é€‰æ‹©èŒƒå›´ï¼‰`);
            } catch (e) {
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æˆ–è·¨åŸŸã€‚æ‚¨å¯ä»¥æ‰‹åŠ¨å¤åˆ¶é¢˜åº“æ ¼å¼åˆ°æ§åˆ¶å°ã€‚');
                console.error(e);
            }
        }

        // è‡ªåŠ¨åŠ è½½é»˜è®¤é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ä¸”é¢˜åº“ä¸ºç©ºï¼‰
        window.addEventListener('load', ()=>{
            const defaultUrl = document.getElementById('libraryUrlInput').value.trim();
            if(defaultUrl) {
                loadFromUrl(defaultUrl, { preserveMistake: true, preserveDrawHistory: true }).catch(()=>{});
            }
        });
    })();
</script>
</body>
</html>