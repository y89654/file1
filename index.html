<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æŠ½é¢˜ Â· å®Œç¾ä¿ç•™è®°å½• Â· èŒƒå›´é‡ç½®</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #f3f6fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 20px;
        }
        .app-container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,20,50,0.15);
            overflow: hidden;
            padding: 24px;
        }
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }
        h2 {
            margin: 0 0 12px 0;
            font-weight: 600;
            font-size: 1.5rem;
            color: #0b2b4a;
            border-left: 7px solid #3b82f6;
            padding-left: 16px;
        }
        .info-bar {
            background: #e6f0ff;
            border-radius: 30px;
            padding: 12px 22px;
            margin: 20px 0 16px 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            color: #004080;
            border: 1px solid #b8d3ff;
        }
        .info-bar span {
            background: white;
            padding: 5px 18px;
            border-radius: 50px;
            font-size: 0.95rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .question-block, .answer-block {
            background: #f9faff;
            border-radius: 24px;
            padding: 20px 24px;
            margin-bottom: 20px;
            border: 1px solid #dde7f5;
        }
        .label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #4b5f7a;
            margin-bottom: 8px;
        }
        .question-text {
            font-size: 1.25rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            color: #0b2b4a;
            font-weight: 500;
        }
        .answer-text {
            font-size: 1.2rem;
            color: #1d4a8b;
            background: #e9f2ff;
            padding: 14px 18px;
            border-radius: 20px;
            min-height: 4rem;
            border: 1px solid #c2dafc;
            white-space: pre-wrap;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 18px 0 12px;
        }
        button {
            background: white;
            border: 1.5px solid #c2d6f0;
            padding: 10px 22px;
            border-radius: 60px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e3e6e;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            flex: 0 1 auto;
        }
        button.primary {
            background: #1f4f9e;
            border-color: #1f4f9e;
            color: white;
        }
        button.warning {
            background: #feebc0;
            border-color: #f3b33d;
            color: #7a4c0d;
        }
        button.accent {
            background: #ddedff;
            border-color: #6d9eec;
        }
        button:hover {
            background: #e3efff;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }
        button.primary:hover {
            background: #0f3d7a;
        }
        .range-selector {
            background: #eaf2ff;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .file-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        input[type="text"], input[type="number"] {
            padding: 12px 18px;
            border: 2px solid #cbdaf0;
            border-radius: 40px;
            font-size: 0.95rem;
            background: white;
        }
        .range-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0 10px;
        }
        .range-inputs label {
            font-weight: 500;
            color: #1e3e6e;
        }
        .range-inputs input {
            width: 90px;
            text-align: center;
        }
        .small-note {
            color: #4d627c;
            font-size: 0.9rem;
            margin: 5px 0 0 2px;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 32px;
            padding: 24px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        .modal-close {
            float: right;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
        }
        .question-list-item {
            padding: 12px;
            border-bottom: 1px solid #dee9f5;
            white-space: pre-wrap;
        }
        .question-list-item strong {
            color: #1f4f9e;
        }
        .reset-range-panel {
            background: #fff3d8;
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #f9cb8b;
        }
    </style>
</head>
<body>
<div class="app-container" id="appContainer">

    <!-- ä¸»ç•Œé¢ panel -->
    <div id="mainPanel" class="panel active">
        <h2>ğŸ“š ä¸»ç•Œé¢</h2>
        <div class="button-group">
            <button class="primary" id="gotoDrawRangeBtn">å¼€å§‹æŠ½å–é¢˜ç›®</button>
            <button class="accent" id="gotoMistakePanelBtn">é”™é¢˜æœ¬</button>
            <button id="viewAllQuestionsBtn" class="accent">æŸ¥çœ‹å…¨éƒ¨é¢˜ç›®</button>
            <button id="reloadLibraryBtn">é‡æ–°åŠ è½½é¢˜åº“</button>
        </div>
        <div class="file-input-row">
            <input type="text" id="libraryUrlInput" placeholder="åœ¨æ­¤ç²˜è´´é¢˜åº“é“¾æ¥" value="https://gist.githubusercontent.com/y89654/b5786f5ed0e4290070a08b5010db7854/raw/file.txt">
            <button id="loadUrlBtn">åŠ è½½</button>
        </div>
        <div class="small-note" id="mainStatus">ğŸ“– é¢˜åº“çŠ¶æ€ï¼šæœªåŠ è½½ / 0é¢˜</div>
    </div>

    <!-- æŠ½å–ç•Œé¢ / ç­”é¢˜ç•Œé¢ (åŒ…å«èŒƒå›´é€‰æ‹©ä¸æŠ½é¢˜) -->
    <div id="drawPanel" class="panel">
        <div id="rangeSelectorView" style="display: block;">
            <h2>ğŸ¯ é€‰æ‹©æŠ½å–èŒƒå›´</h2>
            <div class="range-selector">
                <div style="margin-bottom: 12px; font-weight: 500;">å½“å‰é¢˜åº“å…± <span id="totalCountRange">0</span> é¢˜</div>
                
                <div class="range-inputs">
                    <label>ä»ç¬¬</label>
                    <input type="number" id="rangeStart" min="1" value="1">
                    <label>é¢˜ åˆ°ç¬¬</label>
                    <input type="number" id="rangeEnd" min="1" value="0">
                    <label>é¢˜ (åŒ…å«)</label>
                </div>
                <div class="button-group">
                    <button id="startRangeDrawBtn" class="primary">å¼€å§‹æŠ½å–</button>
                    <button id="backToMainFromRangeBtn">è¿”å›ä¸»ç•Œé¢</button>
                </div>
                <p class="small-note">ğŸ“Œ é»˜è®¤å…¨éƒ¨é¢˜ç›®ã€‚è¾“å…¥èŒƒå›´åç‚¹å‡»â€œå¼€å§‹æŠ½å–â€å³ä»è¯¥åŒºé—´éšæœºæŠ½é¢˜ã€‚</p>
            </div>
        </div>

        <div id="drawQuestionView" style="display: none;">
            <div class="info-bar">
                <span>ğŸ“Œ å½“å‰èŒƒå›´å‰©ä½™ <span id="remainCounter">0</span> é¢˜</span>
                <span>ğŸ“‹ é¢˜åº“æ€»é¢˜ <span id="totalIndicator">0</span></span>
                <span>ğŸ“ å·²æŠ½å– <span id="drawnCount">0</span> é¢˜</span>
            </div>

            <div class="question-block">
                <div class="label">ğŸ“ é¢˜ç›®æ </div>
                <div class="question-text" id="questionDisplay">ï¼ˆç‚¹å‡»æŠ½å–åæ˜¾ç¤ºé¢˜ç›®ï¼‰</div>
            </div>

            <div class="answer-block">
                <div class="label">ğŸ” ç­”æ¡ˆæ   <span style="margin-left: 16px; font-weight: normal;" id="answerHiddenTip">ï¼ˆéšè—ï¼‰</span></div>
                <div class="answer-text" id="answerDisplay">********</div>
            </div>

            <div class="button-group">
                <button id="showAnswerBtn" class="primary">æ˜¾ç¤ºç­”æ¡ˆ</button>
                <button id="prevQuestionBtn">ä¸Šä¸€é¢˜</button>
                <button id="nextQuestionBtn">ä¸‹ä¸€é¢˜</button>
                <button id="resetDrawnBtn" class="warning">é‡ç½®æŠ½å–è®°å½•</button>
                <button id="reselectRangeBtn">é‡æ–°é€‰æ‹©èŒƒå›´</button>
                <button id="addToMistakeBtn" class="warning">åŠ å…¥é”™é¢˜æœ¬</button>
                <button id="backToMainFromDrawBtn">è¿”å›ä¸»ç•Œé¢</button>
            </div>

            <!-- æ–°å¢ï¼šå¸¦èŒƒå›´é€‰æ‹©çš„é‡ç½®é¢æ¿ (é»˜è®¤éšè—) -->
            <div id="resetRangePanel" class="reset-range-panel" style="display: none;">
                <h4 style="margin:0 0 10px 0;">ğŸ”„ é€‰æ‹©é‡ç½®èŒƒå›´</h4>
                <div class="range-inputs" style="margin-top:0;">
                    <label>ä»ç¬¬</label>
                    <input type="number" id="resetRangeStart" min="1" value="1">
                    <label>é¢˜ åˆ°ç¬¬</label>
                    <input type="number" id="resetRangeEnd" min="1" value="0">
                </div>
                <div class="button-group">
                    <button id="confirmResetBtn" class="primary">ç¡®è®¤é‡ç½®</button>
                    <button id="cancelResetBtn">å–æ¶ˆ</button>
                </div>
                <p class="small-note">é‡ç½®åå°†æ¸…ç©ºæŠ½å–å†å²ï¼Œå¹¶é‡æ–°è®¾ç½®å‰©ä½™é¢˜ç›®èŒƒå›´</p>
            </div>
        </div>
    </div>

    <!-- é”™é¢˜æœ¬ panel -->
    <div id="mistakePanel" class="panel">
        <h2>âŒ é”™é¢˜æœ¬</h2>
        <div class="info-bar">
            <span>é”™é¢˜æ€»æ•° <span id="mistakeTotal">0</span></span>
        </div>
        <div class="button-group">
            <button class="primary" id="startMistakeDrawBtn">å¼€å§‹æŠ½å–é”™é¢˜</button>
            <button id="viewAllMistakesBtn">æŸ¥çœ‹æ‰€æœ‰é”™é¢˜</button>
            <button id="resetMistakeDrawnBtn">é‡ç½®å·²æŠ½å–é”™é¢˜</button>
            <button id="backToMainFromMistakeBtn">è¿”å›ä¸»ç•Œé¢</button>
        </div>

        <div id="mistakeDrawView" style="display: none; margin-top: 24px;">
            <div class="info-bar">
                <span>é”™é¢˜å‰©ä½™ <span id="mistakeRemain">0</span> é¢˜</span>
            </div>
            <div class="question-block">
                <div class="label">ğŸ“ é”™é¢˜é¢˜ç›®</div>
                <div class="question-text" id="mistakeQuestionDisplay"></div>
            </div>
            <div class="answer-block">
                <div class="label">ğŸ” ç­”æ¡ˆ</div>
                <div class="answer-text" id="mistakeAnswerDisplay">********</div>
            </div>
            <div class="button-group">
                <button id="showMistakeAnswerBtn" class="primary">æ˜¾ç¤ºç­”æ¡ˆ</button>
                <button id="prevMistakeBtn">ä¸Šä¸€é¢˜</button>
                <button id="nextMistakeBtn">ä¸‹ä¸€é¢˜</button>
                <button id="resetMistakeDrawInViewBtn">é‡ç½®æŠ½å–</button>
                <button id="removeThisMistakeBtn" class="warning">ç§»é™¤è¯¥é”™é¢˜</button>
                <button id="backToMistakeMainBtn">è¿”å›é”™é¢˜æœ¬</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡æ€æ¡†ï¼šæŸ¥çœ‹å…¨éƒ¨é¢˜ç›® -->
<div id="allQuestionsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="modal-close" id="closeModalBtn">&times;</span>
        <h3 style="margin-top: 0;">ğŸ“‹ å…¨éƒ¨é¢˜ç›®</h3>
        <div id="modalQuestionList"></div>
    </div>
</div>

<script>
    (function() {
        // ---------- å…¨å±€æ•°æ® ----------
        let rawLines = [];                      
        let questionList = [];                  
        
        // ä¿ç•™æ•°æ®ï¼šé”™é¢˜æœ¬ã€æŠ½å–è®°å½•
        let mistakeList = [];                    
        
        // å½“å‰æŠ½å–èŒƒå›´ç›¸å…³
        let currentDrawRemaining = [];            // å½“å‰æŠ½å–èŒƒå›´ï¼ˆå‰©ä½™ç´¢å¼•ï¼‰
        let drawnHistory = [];                    // å·²ç»æŠ½å–è¿‡çš„ç´¢å¼•
        let currentDrawIndex = -1;                // å½“å‰å±•ç¤ºçš„æ˜¯drawnHistoryé‡Œçš„ç¬¬å‡ ä¸ª
        let answerVisible = false;                 // å½“å‰æŠ½å–ç•Œé¢æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ

        // å½“å‰é€‰ä¸­çš„èŒƒå›´ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        let currentRangeStart = 1;
        let currentRangeEnd = 0;

        // é”™é¢˜æŠ½å–ç›¸å…³
        let mistakeDrawRemaining = [];             
        let mistakeDrawnHistory = [];
        let currentMistakeIndex = -1;
        let mistakeAnswerVisible = false;

        // UIå…ƒç´ 
        const mainPanel = document.getElementById('mainPanel');
        const drawPanel = document.getElementById('drawPanel');
        const mistakePanel = document.getElementById('mistakePanel');
        const rangeSelectorView = document.getElementById('rangeSelectorView');
        const drawQuestionView = document.getElementById('drawQuestionView');
        const mistakeDrawView = document.getElementById('mistakeDrawView');

        const totalCountRangeSpan = document.getElementById('totalCountRange');
        const remainCounterSpan = document.getElementById('remainCounter');
        const totalIndicatorSpan = document.getElementById('totalIndicator');
        const drawnCountSpan = document.getElementById('drawnCount');
        const questionDisplay = document.getElementById('questionDisplay');
        const answerDisplay = document.getElementById('answerDisplay');
        const answerHiddenTip = document.getElementById('answerHiddenTip');
        const mainStatus = document.getElementById('mainStatus');
        const mistakeTotalSpan = document.getElementById('mistakeTotal');

        // èŒƒå›´è¾“å…¥æ¡†
        const rangeStartInput = document.getElementById('rangeStart');
        const rangeEndInput = document.getElementById('rangeEnd');

        // é‡ç½®èŒƒå›´è¾“å…¥æ¡†
        const resetRangeStart = document.getElementById('resetRangeStart');
        const resetRangeEnd = document.getElementById('resetRangeEnd');
        const resetRangePanel = document.getElementById('resetRangePanel');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');

        // é”™æœ¬é¢˜å†…éƒ¨å…ƒç´ 
        const mistakeQuestionDisplay = document.getElementById('mistakeQuestionDisplay');
        const mistakeAnswerDisplay = document.getElementById('mistakeAnswerDisplay');
        const mistakeRemainSpan = document.getElementById('mistakeRemain');

        // æ¨¡æ€æ¡†å…ƒç´ 
        const modal = document.getElementById('allQuestionsModal');
        const modalList = document.getElementById('modalQuestionList');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // å…³é—­æ¨¡æ€æ¡†
        closeModalBtn.addEventListener('click', ()=> modal.style.display = 'none');
        window.addEventListener('click', (e)=> {
            if(e.target === modal) modal.style.display = 'none';
        });

        // æŸ¥çœ‹å…¨éƒ¨é¢˜ç›®
        document.getElementById('viewAllQuestionsBtn').addEventListener('click', ()=>{
            if(questionList.length === 0) {
                alert('é¢˜åº“ä¸ºç©º');
                return;
            }
            let html = '';
            questionList.forEach((q, idx) => {
                html += `<div class="question-list-item"><strong>${idx+1}.</strong> é¢˜ç›®ï¼š${q.question}<br><span style="color:#1d4a8b;">ç­”æ¡ˆï¼š${q.answer}</span></div>`;
            });
            modalList.innerHTML = html;
            modal.style.display = 'flex';
        });

        // æŒ‰é’®äº‹ä»¶
        document.getElementById('gotoDrawRangeBtn').addEventListener('click', ()=>{
            if(questionList.length === 0) { alert('è¯·å…ˆåŠ è½½é¢˜åº“'); return; }
            
            // æ˜¾ç¤ºæŠ½å–é¢æ¿
            showPanel('draw');
            
            // å…³é”®ä¿®æ”¹ï¼šæ— è®ºä¹‹å‰æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å®Œå…¨ä¿ç•™è®°å½•
            // åªæ˜¯æ ¹æ®å½“å‰çŠ¶æ€å†³å®šæ˜¾ç¤ºå“ªä¸ªå­è§†å›¾
            if (drawnHistory.length > 0 && currentDrawIndex >= 0) {
                // æœ‰æŠ½å–å†å²ï¼Œç›´æ¥æ˜¾ç¤ºç­”é¢˜è§†å›¾
                rangeSelectorView.style.display = 'none';
                drawQuestionView.style.display = 'block';
                
                // æ›´æ–°èŒƒå›´è¾“å…¥æ¡†çš„å€¼ä¸ºå½“å‰ä¿å­˜çš„èŒƒå›´
                rangeStartInput.value = currentRangeStart;
                rangeEndInput.value = currentRangeEnd;
                
                // åˆ·æ–°æ˜¾ç¤º
                updateDrawUI();
            } else {
                // æ²¡æœ‰å†å²ï¼Œæ˜¾ç¤ºèŒƒå›´é€‰æ‹©è§†å›¾
                rangeSelectorView.style.display = 'block';
                drawQuestionView.style.display = 'none';
                rangeStartInput.value = 1;
                rangeEndInput.value = questionList.length;
                updateRangeInfo();
            }
            
            // ç¡®ä¿é‡ç½®é¢æ¿æ˜¯éšè—çš„
            resetRangePanel.style.display = 'none';
        });

        document.getElementById('gotoMistakePanelBtn').addEventListener('click', ()=>{
            showPanel('mistake');
            mistakeDrawView.style.display = 'none';
            updateMistakeUI();
        });

        document.getElementById('reloadLibraryBtn').addEventListener('click', ()=>{
            const url = document.getElementById('libraryUrlInput').value.trim();
            if(url) loadFromUrl(url, { preserveMistake: true, preserveDrawHistory: true }); 
            else alert('è¯·åœ¨è¾“å…¥æ¡†ä¸­å¡«å†™é“¾æ¥');
        });

        document.getElementById('loadUrlBtn').addEventListener('click', ()=>{
            const url = document.getElementById('libraryUrlInput').value.trim();
            if(url) loadFromUrl(url, { preserveMistake: true, preserveDrawHistory: true }); 
            else alert('è¯·è¾“å…¥é“¾æ¥');
        });

        // è¿”å›ä¸»ç•Œé¢ â€”â€” åªåˆ‡æ¢é¢æ¿ï¼Œç»å¯¹ä¸æ¸…ç©ºä»»ä½•è®°å½•
        document.getElementById('backToMainFromRangeBtn').addEventListener('click', ()=> showPanel('main'));
        document.getElementById('backToMainFromDrawBtn').addEventListener('click', ()=> showPanel('main'));
        document.getElementById('backToMainFromMistakeBtn').addEventListener('click', ()=> showPanel('main'));

        // å¼€å§‹æŠ½å–(èŒƒå›´ç•Œé¢ç‚¹å‡»)
        document.getElementById('startRangeDrawBtn').addEventListener('click', ()=>{
            if(questionList.length === 0) return alert('é¢˜åº“ä¸ºç©º');
            
            // è·å–èŒƒå›´è¾“å…¥
            let start = parseInt(rangeStartInput.value);
            let end = parseInt(rangeEndInput.value);
            if (isNaN(start) || start < 1) start = 1;
            if (isNaN(end) || end > questionList.length) end = questionList.length;
            if (start > end) {
                alert('èµ·å§‹é¢˜å·ä¸èƒ½å¤§äºç»“æŸé¢˜å·ï¼Œå°†ä½¿ç”¨å…¨éƒ¨èŒƒå›´');
                start = 1;
                end = questionList.length;
            }
            
            // ä¿å­˜å½“å‰èŒƒå›´
            currentRangeStart = start;
            currentRangeEnd = end;
            
            const startIdx = start - 1;
            const endIdx = end - 1;
            
            // ç”Ÿæˆå‰©ä½™ç´¢å¼•åˆ—è¡¨
            currentDrawRemaining = [];
            for (let i = startIdx; i <= endIdx; i++) {
                currentDrawRemaining.push(i);
            }
            
            if (currentDrawRemaining.length === 0) {
                alert('è¯¥èŒƒå›´æ— æœ‰æ•ˆé¢˜ç›®');
                return;
            }

            // é‡ç½®å†å²ï¼ˆå› ä¸ºæ˜¯æ–°èŒƒå›´ï¼Œæ—§å†å²ä¸å†é€‚ç”¨ï¼‰
            drawnHistory = [];
            currentDrawIndex = -1;
            
            // æŠ½å–ç¬¬ä¸€é¢˜
            pickNewQuestionFromRemaining();
            
            rangeSelectorView.style.display = 'none';
            drawQuestionView.style.display = 'block';
            resetRangePanel.style.display = 'none';
            updateDrawUI();
        });

        // æ˜¾ç¤ºç­”æ¡ˆ
        document.getElementById('showAnswerBtn').addEventListener('click', ()=>{
            if(currentDrawIndex >= 0 && drawnHistory.length > 0 && currentDrawIndex < drawnHistory.length) {
                const qIdx = drawnHistory[currentDrawIndex];
                if (qIdx >= 0 && qIdx < questionList.length) {
                    answerVisible = true;
                    updateDrawUI();
                } else {
                    alert('å½“å‰é¢˜ç›®ç´¢å¼•å·²å¤±æ•ˆ');
                }
            } else alert('æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„é¢˜ç›®');
        });

        document.getElementById('prevQuestionBtn').addEventListener('click', ()=>{
            if(drawnHistory.length === 0) return alert('æ— æŠ½å–è®°å½•');
            if (currentDrawIndex > 0) {
                const prevIdx = drawnHistory[currentDrawIndex - 1];
                if (prevIdx >= 0 && prevIdx < questionList.length) {
                    currentDrawIndex--;
                    answerVisible = false;
                    updateDrawUI();
                } else {
                    alert('ä¸Šä¸€é¢˜ç´¢å¼•å·²å¤±æ•ˆ');
                }
            } else alert('å·²ç»æ˜¯ç¬¬ä¸€é¢˜');
        });

        document.getElementById('nextQuestionBtn').addEventListener('click', ()=>{
            if(drawnHistory.length === 0) return;
            if (currentDrawIndex < drawnHistory.length - 1) {
                const nextIdx = drawnHistory[currentDrawIndex + 1];
                if (nextIdx >= 0 && nextIdx < questionList.length) {
                    currentDrawIndex++;
                    answerVisible = false;
                    updateDrawUI();
                } else {
                    alert('ä¸‹ä¸€é¢˜ç´¢å¼•å·²å¤±æ•ˆ');
                }
            } else {
                pickNewQuestionFromRemaining();
            }
        });

        // é‡ç½®æŠ½å–è®°å½•æŒ‰é’® - æ˜¾ç¤ºèŒƒå›´é€‰æ‹©é¢æ¿
        document.getElementById('resetDrawnBtn').addEventListener('click', ()=>{
            // åˆå§‹åŒ–é‡ç½®èŒƒå›´è¾“å…¥æ¡†ä¸ºå½“å‰èŒƒå›´æˆ–é»˜è®¤å€¼
            if (currentRangeEnd >= currentRangeStart) {
                resetRangeStart.value = currentRangeStart;
                resetRangeEnd.value = currentRangeEnd;
            } else {
                resetRangeStart.value = 1;
                resetRangeEnd.value = questionList.length;
            }
            resetRangePanel.style.display = 'block';
        });

        // ç¡®è®¤é‡ç½®
        confirmResetBtn.addEventListener('click', ()=>{
            let start = parseInt(resetRangeStart.value);
            let end = parseInt(resetRangeEnd.value);
            
            if (isNaN(start) || start < 1) start = 1;
            if (isNaN(end) || end > questionList.length) end = questionList.length;
            if (start > end) {
                alert('èµ·å§‹é¢˜å·ä¸èƒ½å¤§äºç»“æŸé¢˜å·');
                return;
            }
            
            // æ›´æ–°å½“å‰èŒƒå›´
            currentRangeStart = start;
            currentRangeEnd = end;
            
            const startIdx = start - 1;
            const endIdx = end - 1;
            
            // é‡æ–°ç”Ÿæˆå‰©ä½™ç´¢å¼•åˆ—è¡¨
            currentDrawRemaining = [];
            for (let i = startIdx; i <= endIdx; i++) {
                currentDrawRemaining.push(i);
            }
            
            // æ¸…ç©ºå†å²
            drawnHistory = [];
            currentDrawIndex = -1;
            answerVisible = false;
            
            // éšè—é‡ç½®é¢æ¿
            resetRangePanel.style.display = 'none';
            
            // æ›´æ–°æ˜¾ç¤º
            questionDisplay.innerText = 'èŒƒå›´å·²é‡ç½®ï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€é¢˜æŠ½å–';
            answerDisplay.innerText = '********';
            answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
            updateRemainOnly();
            updateDrawnCount();
        });

        // å–æ¶ˆé‡ç½®
        cancelResetBtn.addEventListener('click', ()=>{
            resetRangePanel.style.display = 'none';
        });

        document.getElementById('reselectRangeBtn').addEventListener('click', ()=>{
            rangeSelectorView.style.display = 'block';
            drawQuestionView.style.display = 'none';
            resetRangePanel.style.display = 'none';
            rangeStartInput.value = currentRangeStart;
            rangeEndInput.value = currentRangeEnd;
            updateRangeInfo();
        });

        document.getElementById('addToMistakeBtn').addEventListener('click', ()=>{
            if(currentDrawIndex >= 0 && drawnHistory.length > 0) {
                const qIdx = drawnHistory[currentDrawIndex];
                if (qIdx >= 0 && qIdx < questionList.length) {
                    const questionObj = questionList[qIdx];
                    if(!mistakeList.some(item => item.question === questionObj.question && item.answer === questionObj.answer)) {
                        mistakeList.push({...questionObj});
                        updateMistakeTotal();
                        alert('å·²åŠ å…¥é”™é¢˜æœ¬');
                    } else alert('å·²åœ¨é”™é¢˜æœ¬ä¸­');
                } else alert('é¢˜ç›®ç´¢å¼•æ— æ•ˆï¼Œæ— æ³•åŠ å…¥é”™é¢˜æœ¬');
            } else alert('æ²¡æœ‰é€‰ä¸­é¢˜ç›®');
        });

        // é”™é¢˜æœ¬å†…éƒ¨åŠŸèƒ½ (ä¿æŒä¸å˜)
        document.getElementById('startMistakeDrawBtn').addEventListener('click', ()=>{
            if(mistakeList.length === 0) return alert('é”™é¢˜æœ¬ä¸ºç©º');
            mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
            mistakeDrawnHistory = [];
            currentMistakeIndex = -1;
            mistakeAnswerVisible = false;
            pickNewMistakeFromRemaining();
            mistakeDrawView.style.display = 'block';
            updateMistakeDrawUI();
        });
        document.getElementById('viewAllMistakesBtn').addEventListener('click', ()=>{
            if(mistakeList.length === 0) alert('æš‚æ— é”™é¢˜');
            else alert('æ‰€æœ‰é”™é¢˜:\n' + mistakeList.map((q,i)=>`${i+1}. ${q.question} â€”â€” ç­”æ¡ˆ: ${q.answer}`).join('\n'));
        });
        document.getElementById('resetMistakeDrawnBtn').addEventListener('click', ()=>{
            mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
            mistakeDrawnHistory = [];
            currentMistakeIndex = -1;
            mistakeAnswerVisible = false;
            updateMistakeTotal();
            if(mistakeDrawView.style.display === 'block') {
                mistakeQuestionDisplay.innerText = 'é‡ç½®å®Œæˆï¼Œç‚¹å‡»å¼€å§‹æŠ½å–é”™é¢˜';
                mistakeAnswerDisplay.innerText = '********';
            }
        });
        document.getElementById('backToMistakeMainBtn').addEventListener('click', ()=>{
            mistakeDrawView.style.display = 'none';
        });
        document.getElementById('showMistakeAnswerBtn').addEventListener('click', ()=>{
            if(currentMistakeIndex >= 0 && mistakeDrawnHistory.length > 0) {
                mistakeAnswerVisible = true;
                updateMistakeDrawUI();
            } else alert('æ— é”™é¢˜');
        });
        document.getElementById('prevMistakeBtn').addEventListener('click', ()=>{
            if(mistakeDrawnHistory.length === 0) return;
            if(currentMistakeIndex > 0) {
                currentMistakeIndex--;
                mistakeAnswerVisible = false;
                updateMistakeDrawUI();
            } else alert('å·²æ˜¯ç¬¬ä¸€é¢˜');
        });
        document.getElementById('nextMistakeBtn').addEventListener('click', ()=>{
            if(mistakeDrawnHistory.length === 0) return;
            if(currentMistakeIndex < mistakeDrawnHistory.length - 1) {
                currentMistakeIndex++;
                mistakeAnswerVisible = false;
                updateMistakeDrawUI();
            } else {
                pickNewMistakeFromRemaining();
            }
        });
        document.getElementById('resetMistakeDrawInViewBtn').addEventListener('click', ()=>{
            mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
            mistakeDrawnHistory = [];
            currentMistakeIndex = -1;
            mistakeAnswerVisible = false;
            updateMistakeDrawUI();
        });
        document.getElementById('removeThisMistakeBtn').addEventListener('click', ()=>{
            if(currentMistakeIndex >= 0 && mistakeDrawnHistory.length > 0) {
                const mistakeIdx = mistakeDrawnHistory[currentMistakeIndex];
                mistakeList.splice(mistakeIdx, 1);
                mistakeDrawRemaining = mistakeList.map((_, idx) => idx);
                mistakeDrawnHistory = [];
                currentMistakeIndex = -1;
                mistakeAnswerVisible = false;
                updateMistakeTotal();
                if(mistakeList.length === 0) {
                    mistakeDrawView.style.display = 'none';
                } else {
                    pickNewMistakeFromRemaining();
                }
                updateMistakeDrawUI();
            } else alert('æ²¡æœ‰é€‰ä¸­é”™é¢˜');
        });

        // ------- è¾…åŠ©å‡½æ•° ---------
        function showPanel(panel) {
            mainPanel.classList.remove('active');
            drawPanel.classList.remove('active');
            mistakePanel.classList.remove('active');
            if(panel === 'main') mainPanel.classList.add('active');
            if(panel === 'draw') drawPanel.classList.add('active');
            if(panel === 'mistake') mistakePanel.classList.add('active');
        }

        function updateRangeInfo() {
            totalCountRangeSpan.innerText = questionList.length;
            rangeEndInput.max = questionList.length;
        }

        function updateRemainOnly() {
            let remain = currentDrawRemaining.length;
            remainCounterSpan.innerText = remain;
            totalIndicatorSpan.innerText = questionList.length;
        }

        function updateDrawnCount() {
            drawnCountSpan.innerText = drawnHistory.length;
        }

        function updateDrawUI() {
            if(drawnHistory.length > 0 && currentDrawIndex >= 0 && currentDrawIndex < drawnHistory.length) {
                const qIdx = drawnHistory[currentDrawIndex];
                if (qIdx >= 0 && qIdx < questionList.length) {
                    const q = questionList[qIdx];
                    questionDisplay.innerText = q.question;
                    if(answerVisible) {
                        answerDisplay.innerText = q.answer;
                        answerHiddenTip.innerText = 'ï¼ˆæ˜¾ç¤ºï¼‰';
                    } else {
                        answerDisplay.innerText = '********';
                        answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
                    }
                } else {
                    questionDisplay.innerText = 'å½“å‰é¢˜ç›®ç´¢å¼•æ— æ•ˆ';
                    answerDisplay.innerText = '********';
                    answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
                }
            } else {
                questionDisplay.innerText = 'æš‚æ— é¢˜ç›®ï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€é¢˜æŠ½å–';
                answerDisplay.innerText = '********';
                answerHiddenTip.innerText = 'ï¼ˆéšè—ï¼‰';
            }
            updateRemainOnly();
            updateDrawnCount();
        }

        function pickNewQuestionFromRemaining() {
            if(currentDrawRemaining.length === 0) {
                alert('å½“å‰èŒƒå›´å·²ç»æ²¡æœ‰é¢˜ç›®äº†ï¼Œè¯·é‡ç½®å·²æŠ½å–æˆ–é‡æ–°é€‰æ‹©èŒƒå›´');
                return;
            }
            const randomIndex = Math.floor(Math.random() * currentDrawRemaining.length);
            const selectedIdx = currentDrawRemaining[randomIndex];
            currentDrawRemaining.splice(randomIndex, 1);
            drawnHistory.push(selectedIdx);
            currentDrawIndex = drawnHistory.length - 1;
            answerVisible = false;
            updateDrawUI();
        }

        function updateMistakeTotal() {
            mistakeTotalSpan.innerText = mistakeList.length;
        }

        function pickNewMistakeFromRemaining() {
            if(mistakeDrawRemaining.length === 0) {
                alert('é”™é¢˜å‰©ä½™å·²ç©ºï¼Œå¯é‡ç½®æŠ½å–');
                return;
            }
            const rand = Math.floor(Math.random() * mistakeDrawRemaining.length);
            const selectedMistakeIdx = mistakeDrawRemaining[rand];
            mistakeDrawRemaining.splice(rand, 1);
            mistakeDrawnHistory.push(selectedMistakeIdx);
            currentMistakeIndex = mistakeDrawnHistory.length - 1;
            mistakeAnswerVisible = false;
            updateMistakeDrawUI();
        }

        function updateMistakeDrawUI() {
            if(mistakeDrawnHistory.length > 0 && currentMistakeIndex >= 0) {
                const mistakeIdx = mistakeDrawnHistory[currentMistakeIndex];
                const q = mistakeList[mistakeIdx];
                mistakeQuestionDisplay.innerText = q.question;
                mistakeAnswerDisplay.innerText = mistakeAnswerVisible ? q.answer : '********';
            } else {
                mistakeQuestionDisplay.innerText = 'æ— é”™é¢˜';
                mistakeAnswerDisplay.innerText = '********';
            }
            mistakeRemainSpan.innerText = mistakeDrawRemaining.length;
        }

        function updateMistakeUI() {
            mistakeTotalSpan.innerText = mistakeList.length;
        }

        // è§£æé¢˜åº“ â€”â€” è¯†åˆ« begining......ending
        function parseQuestionsFromLines(lines) {
            const fullText = lines.join('\n');
            const regex = /begining(.*?)ending/gs;
            const qlist = [];
            let match;
            while ((match = regex.exec(fullText)) !== null) {
                let block = match[1].trim();
                const ansIndex = block.lastIndexOf('ç­”æ¡ˆï¼š');
                if (ansIndex !== -1) {
                    const questionPart = block.substring(0, ansIndex).trim();
                    let answerPart = block.substring(ansIndex + 3).trim();
                    qlist.push({ question: questionPart, answer: answerPart });
                } else {
                    qlist.push({ question: block, answer: '' });
                }
            }
            if (qlist.length === 0) {
                for(let line of lines) {
                    line = line.trim();
                    if(line === '') continue;
                    const ansIndex = line.lastIndexOf('ç­”æ¡ˆï¼š');
                    if(ansIndex !== -1) {
                        const questionPart = line.substring(0, ansIndex).trim();
                        let answerPart = line.substring(ansIndex + 3).trim();
                        qlist.push({ question: questionPart, answer: answerPart });
                    } else {
                        qlist.push({ question: line, answer: '' });
                    }
                }
            }
            return qlist;
        }

        // åŠ è½½é¢˜åº“ï¼Œä¿ç•™é”™é¢˜å’ŒæŠ½å–å†å²
        async function loadFromUrl(url, options = { preserveMistake: true, preserveDrawHistory: true }) {
            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                const text = await response.text();
                rawLines = text.split(/\r?\n/);
                const newQuestionList = parseQuestionsFromLines(rawLines);
                
                questionList = newQuestionList;
                mainStatus.innerText = `ğŸ“– é¢˜åº“å·²åŠ è½½ï¼š${questionList.length}é¢˜`;
                
                if (!options.preserveMistake) {
                    mistakeList = [];
                }
                
                // å¦‚æœé¢˜åº“é•¿åº¦å˜åŒ–ï¼Œå¯èƒ½ä½¿éƒ¨åˆ†ç´¢å¼•å¤±æ•ˆï¼Œä½†ä¿ç•™å†å²ï¼ˆç”±UIæ£€æŸ¥å¤„ç†ï¼‰
                
                // æ›´æ–°èŒƒå›´è¾“å…¥
                rangeEndInput.max = questionList.length;
                resetRangeEnd.max = questionList.length;
                
                updateRangeInfo();
                updateMistakeTotal();
                
                alert(`æˆåŠŸåŠ è½½ ${questionList.length} é“é¢˜ç›®ï¼Œé”™é¢˜æœ¬ ${mistakeList.length} é¢˜ï¼ŒæŠ½å–è®°å½•å·²ä¿ç•™`);
            } catch (e) {
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æˆ–è·¨åŸŸã€‚');
                console.error(e);
            }
        }

        // è‡ªåŠ¨åŠ è½½é»˜è®¤é“¾æ¥
        window.addEventListener('load', ()=>{
            const defaultUrl = document.getElementById('libraryUrlInput').value.trim();
            if(defaultUrl) {
                loadFromUrl(defaultUrl, { preserveMistake: true, preserveDrawHistory: true }).catch(()=>{});
            }
        });
    })();
</script>
</body>
</html>